{% extends "layouts/base.html" %}

{% block content %}
<div class="container-md px-4 my-5">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 fw-bold mb-1">Deals & Card Perks</h1>
      <div class="text-muted small">
        Best offers first — see full details on the <a href="{% url 'cards' %}">My Cards</a> page.
      </div>
    </div>
    <div class="text-end">
      <div class="text-uppercase small text-muted">Cards Loaded</div>
      <div class="fs-4 fw-semibold">{{ cards|length }}</div>
    </div>
  </div>

  <div class="row align-items-center mb-3">
    <div class="col-auto fw-semibold">Filter Deals:</div>
    <div class="col-auto">
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dealFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Add Filter
        </button>
        <ul class="dropdown-menu" aria-labelledby="dealFilterDropdown" id="dealDropdownFilters"></ul>
      </div>
    </div>
    <div class="col" id="activeFilters"></div>
  </div>

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 mb-0">Deals Spotlight</h2>
    <div class="small text-muted" id="dealCount">0 deals</div>
  </div>
  <div id="dealsGrid" class="row g-4"></div>

  <noscript>
    <div class="row g-4 mt-4">
      {% for deal in deals|dictsort:"expiry_date" %}
        <div class="col-12 col-md-6">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="fw-bold">{{ deal.title }}</div>
              <div class="text-muted">{{ deal.expiry_date }}</div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </noscript>
</div>

{% if deals %}
  {% for deal in deals %}
  <script>
    (window._deals = window._deals || []).push({
      type: "{{ deal.deal_type|default:'Special'|escapejs }}", // Uses DB deal_type
      title: "{{ deal.title|escapejs }}",
      subtitle: "{{ deal.subtitle|default:''|escapejs }}",
      benefit: "{{ deal.benefit|default:''|escapejs }}",
      card: "{{ deal.card_name|default:''|escapejs }}",
      issuer: "{{ deal.issuer|default:'—'|escapejs }}",
      expires: "{{ deal.expiry_date|default:''|escapejs }}", // DIRECT MAPPING of DB expiry_date
      finer_details: "{{ deal.finer_details|default:''|escapejs }}"
    });
  </script>
  {% endfor %}
{% endif %}

{% for c in cards %}
  {% if c.welcome_bonus %}
    <script>
      (window._deals = window._deals || []).push({
        type: "welcome",
        title: {% if c.welcome_bonus.points %}"{{ c.welcome_bonus.points|floatformat:0 }} pts"{% elif c.welcome_bonus.cash_back %}"${{ c.welcome_bonus.cash_back|floatformat:0 }} cash"{% elif c.welcome_bonus.points_or_cash %}"{{ c.welcome_bonus.points_or_cash|floatformat:0 }} value"{% else %}"Welcome Offer"{% endif %},
        subtitle: {% if c.welcome_bonus.spend_requirement and c.welcome_bonus.time_frame_months %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} in {{ c.welcome_bonus.time_frame_months }} mo"
        {% elif c.welcome_bonus.spend_requirement %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} spend"
        {% elif c.welcome_bonus.time_frame_months %}
          "In {{ c.welcome_bonus.time_frame_months }} months"
        {% else %}
          ""
        {% endif %},
        card: "{{ c.card_name|escapejs }}",
        issuer: "{{ c.issuer|default:'—'|escapejs }}",
        expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
      });
    </script>
  {% endif %}

  {% if c.perks %}
    {% for p in c.perks %}
      <script>
        (window._deals = window._deals || []).push({
          type: "perk",
          title: "{{ p.perk_name|escapejs }}",
          subtitle: "{% if p.frequency %}{{ p.frequency|escapejs }}{% elif p.description %}{{ p.description|escapejs }}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}

  {% if c.bonus_categories %}
    {% for bc in c.bonus_categories %}
      <script>
        (window._deals = window._deals || []).push({
          type: "category",
          title: "{{ bc.category_name|escapejs }}{% if bc.reward_rate %} · {{ bc.reward_rate|floatformat:2 }}x{% endif %}",
          subtitle: "{% if bc.cap %}Cap ${{ bc.cap|floatformat:0 }}{% if bc.note %} · {{ bc.note|escapejs }}{% endif %}{% else %}{% if bc.note %}{{ bc.note|escapejs }}{% endif %}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}
{% endfor %}

<script>
(function(){
  const allDeals = (window._deals = window._deals || []).filter(Boolean);

  function getTag(d){
    const t = (d.type || '').toLowerCase();
    if(t === 'welcome') return 'Welcome';
    if(t === 'perk') return 'Perk';
    if(t.includes('travel')) return 'Travel';
    if(t.includes('dining') || t.includes('food')) return 'Food';
    if(t.includes('offer') || t.includes('deal')) return 'Offers';
    if(t === 'category') {
      if(d.title.includes('Travel')) return 'Travel';
      if(d.title.includes('Cheap')) return 'Cheap';
      return 'Food/Entertainment';
    }
    return 'Offers'; 
  }

  const tags = Array.from(new Set(allDeals.map(getTag))).sort();

  function parseExpiry(exp) {
    if (!exp) return new Date('2099-12-31');
    const d = new Date(exp);
    return isNaN(d.getTime()) ? new Date('2099-12-31') : d;
  }

  const filterDropdown = document.getElementById('dealDropdownFilters');
  const activeFiltersSpan = document.getElementById('activeFilters');
  let activeFilters = [...tags];

  function renderDropdown() {
    filterDropdown.innerHTML = '';
    let added = false;
    tags.forEach(tag => {
      if (!activeFilters.includes(tag)) {
        const id = 'filter-' + tag.replace(/[^a-zA-Z0-9]/g, '');
        filterDropdown.innerHTML += `
          <li>
            <a class="dropdown-item" href="#" data-filter="${tag}" id="${id}">${tag}</a>
          </li>
        `;
        added = true;
      }
    });
    if (!added) {
      filterDropdown.innerHTML = '<li class="dropdown-item text-muted" style="pointer-events:none;">No more filters</li>';
    }
  }

  function renderActiveFilters() {
    activeFiltersSpan.innerHTML = activeFilters.map(tag => `
      <span class="badge bg-light border text-dark me-1 mb-1" style="font-size:0.95em;">
        ${tag}
        <button type="button" class="btn btn-sm btn-close ms-1" aria-label="Remove" style="font-size:0.7em;vertical-align:middle;" data-remove-filter="${tag}"></button>
      </span>
    `).join('');
  }

  function renderDeals() {
    renderDropdown();
    renderActiveFilters();
    const grid = document.getElementById('dealsGrid');
    const count = document.getElementById('dealCount');
    const checked = activeFilters;

    const filtered = allDeals
      .filter(d => checked.includes(getTag(d)))
      .sort((a, b) => parseExpiry(a.expires) - parseExpiry(b.expires));

    count.textContent = `${filtered.length} deal${filtered.length === 1 ? '' : 's'}`;

    if (!filtered.length) {
      grid.innerHTML = '<div class="text-muted small">No current deals.</div>';
      return;
    }

    grid.innerHTML = filtered.slice(0, 24).map(d => {
      const cap = [d.card, d.issuer].filter(Boolean).join(' • ');
      const exp = d.expires ? `Ends ${d.expires}` : ''; 
      const tag = getTag(d);

      // No highlight for points/cash
      const benefitHtml = d.benefit
        ? `<div class="mb-2">${d.benefit}</div>`
        : '';

      return `
        <div class="col-12 col-md-6">
          <div class="card h-100" style="border-radius:14px;box-shadow:0 8px 24px -12px rgba(0,0,0,.15)">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="badge bg-light border text-dark">${tag}</span>
                <span class="small text-muted" style="min-width:90px;text-align:right;">${exp || "—"}</span>
              </div>
              <div class="fw-bold mb-1" style="font-size:1.1rem">${d.title || ''}</div>
              ${d.subtitle ? `<div class="text-muted small mb-1">${d.subtitle}</div>` : ''}
              ${benefitHtml}
              <div class="d-flex align-items-center justify-content-between mt-2">
                <div class="text-muted small">
                  <i class="bi bi-credit-card me-1"></i>${d.card} <span class="mx-1">•</span> ${d.issuer}
                </div>
                ${d.finer_details ? `<div class="text-muted small text-end">${d.finer_details}</div>` : ''}
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  // Event Listeners
  filterDropdown.addEventListener('click', function(e){
    const tag = e.target.getAttribute('data-filter');
    if(tag && !activeFilters.includes(tag)){
      activeFilters.push(tag);
      renderDeals();
    }
    e.preventDefault();
  });

  activeFiltersSpan.addEventListener('click', function(e){
    const tag = e.target.getAttribute('data-remove-filter');
    if(tag){
      activeFilters = activeFilters.filter(t => t !== tag);
      renderDeals();
    }
  });

  renderDeals();
})();
</script>
{% endblock %}