{% extends "layouts/base.html" %}

{% block content %}
<div class="container-md px-4 my-5">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 fw-bold mb-1">Deals & Card Perks</h1>
      <div class="text-muted small">
        Best offers first — see full details on the <a href="{% url 'cards' %}">My Cards</a> page.
      </div>
    </div>
    <div class="text-end">
      <div class="text-uppercase small text-muted">Cards Loaded</div>
      <div class="fs-4 fw-semibold">{{ cards|length }}</div>
    </div>
  </div>

  <!-- Filter Row -->
  <div class="row align-items-center mb-3">
    <div class="col-auto fw-semibold">Filter Deals:</div>
    <div class="col-auto">
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dealFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Add Filter
        </button>
        <ul class="dropdown-menu" aria-labelledby="dealFilterDropdown" id="dealDropdownFilters"></ul>
      </div>
    </div>
    <div class="col" id="activeFilters"></div>
  </div>

  <!-- Deals Grid -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 mb-0">Deals Spotlight</h2>
    <div class="small text-muted" id="dealCount">0 deals</div>
  </div>
  <div id="dealsGrid" class="row g-4"></div>
</div>

<!-- Build the deals array from cards -->
{% for c in cards %}
  {% if c.welcome_bonus %}
    <script>
      (window._deals = window._deals || []).push({
        type: "welcome",
        title: {% if c.welcome_bonus.points %}"{{ c.welcome_bonus.points|floatformat:0 }} pts"{% elif c.welcome_bonus.cash_back %}"${{ c.welcome_bonus.cash_back|floatformat:0 }} cash"{% elif c.welcome_bonus.points_or_cash %}"{{ c.welcome_bonus.points_or_cash|floatformat:0 }} value"{% else %}"Welcome Offer"{% endif %},
        subtitle: {% if c.welcome_bonus.spend_requirement and c.welcome_bonus.time_frame_months %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} in {{ c.welcome_bonus.time_frame_months }} mo"
        {% elif c.welcome_bonus.spend_requirement %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} spend"
        {% elif c.welcome_bonus.time_frame_months %}
          "In {{ c.welcome_bonus.time_frame_months }} months"
        {% else %}
          ""
        {% endif %},
        card: "{{ c.card_name|escapejs }}",
        issuer: "{{ c.issuer|default:'—'|escapejs }}",
        expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
      });
    </script>
  {% endif %}

  {% if c.perks %}
    {% for p in c.perks %}
      <script>
        (window._deals = window._deals || []).push({
          type: "perk",
          title: "{{ p.perk_name|escapejs }}",
          subtitle: "{% if p.frequency %}{{ p.frequency|escapejs }}{% elif p.description %}{{ p.description|escapejs }}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}

  {% if c.bonus_categories %}
    {% for bc in c.bonus_categories %}
      <script>
        (window._deals = window._deals || []).push({
          type: "category",
          title: "{{ bc.category_name|escapejs }}{% if bc.reward_rate %} · {{ bc.reward_rate|floatformat:2 }}x{% endif %}",
          subtitle: "{% if bc.cap %}Cap ${{ bc.cap|floatformat:0 }}{% if bc.note %} · {{ bc.note|escapejs }}{% endif %}{% else %}{% if bc.note %}{{ bc.note|escapejs }}{% endif %}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}
{% endfor %}

<!-- Render and filter deals (fixed JS) -->
<script>
(function(){
  const allDeals = (window._deals || []).filter(Boolean);

  function getTag(d){
    if(d.type==='welcome') return 'Welcome';
    if(d.type==='perk') return 'Perk';
    if(d.type==='category') {
      if(d.title.includes('Travel')) return 'Travel';
      if(d.title.includes('Cheap')) return 'Cheap';
      return 'Food/Entertainment';
    }
    return 'Food/Entertainment';
  }

  const tags = Array.from(new Set(allDeals.map(getTag)));

  // Helper to parse date or return a far future date if missing
  function parseExpiry(exp) {
    if (!exp) return new Date('2099-12-31');
    // Try to parse YYYY-MM-DD
    const d = new Date(exp);
    return isNaN(d.getTime()) ? new Date('2099-12-31') : d;
  }

  // Dropdown filter logic
  const filterDropdown = document.getElementById('dealDropdownFilters');
  const activeFiltersSpan = document.getElementById('activeFilters');
  let activeFilters = [...tags]; // Start with all filters active

  // Populate dropdown, removing already active filters
  function renderDropdown() {
    filterDropdown.innerHTML = '';
    let added = false;
    tags.forEach(tag => {
      if (!activeFilters.includes(tag)) {
        const id = 'filter-' + tag.replace(/\s+/g, '');
        filterDropdown.innerHTML += `
          <li>
            <a class="dropdown-item" href="#" data-filter="${tag}" id="${id}">${tag}</a>
          </li>
        `;
        added = true;
      }
    });
    if (!added) {
      filterDropdown.innerHTML = '<li class="dropdown-item text-muted" style="pointer-events:none;">No more filters</li>';
    }
  }

  // Render active filter labels with x
  function renderActiveFilters() {
    activeFiltersSpan.innerHTML = activeFilters.map(tag => `
      <span class="badge bg-light border text-dark me-1 mb-1" style="font-size:0.95em;">
        ${tag}
        <button type="button" class="btn btn-sm btn-close ms-1" aria-label="Remove" style="font-size:0.7em;vertical-align:middle;" data-remove-filter="${tag}"></button>
      </span>
    `).join('');
  }

  // Render deals
  function renderDeals() {
    renderDropdown();
    renderActiveFilters();
    const grid = document.getElementById('dealsGrid');
    const count = document.getElementById('dealCount');
    const checked = activeFilters;

    // Sort deals by expiry date, closest first
    const filtered = allDeals
      .filter(d => checked.includes(getTag(d)))
      .sort((a, b) => parseExpiry(a.expires) - parseExpiry(b.expires));

    count.textContent = `${filtered.length} deal${filtered.length === 1 ? '' : 's'}`;

    if (!filtered.length) {
      grid.innerHTML = '<div class="text-muted small">No current deals.</div>';
      return;
    }

    grid.innerHTML = filtered.slice(0, 24).map(d => {
      const cap = [d.card, d.issuer].filter(Boolean).join(' • ');
      const exp = d.expires ? `Ends ${d.expires}` : '';
      const tag = getTag(d);

      return `
        <div class="col-12 col-md-6">
          <div class="card h-100" style="border-radius:14px;box-shadow:0 8px 24px -12px rgba(0,0,0,.15)">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-1">
                <span class="badge bg-light border text-dark">${tag}</span>
              </div>
              <div class="fw-bold" style="font-size:1.05rem">${d.title || ''}</div>
              ${d.subtitle ? `<div class="text-muted small mt-1">${d.subtitle}</div>` : ''}
              <div class="d-flex align-items-center justify-content-between mt-3">
                <div class="text-muted small">${cap}</div>
                <div class="text-muted small">${exp}</div>
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  // Dropdown click to add filter
  filterDropdown.addEventListener('click', function(e){
    const tag = e.target.getAttribute('data-filter');
    if(tag && !activeFilters.includes(tag)){
      activeFilters.push(tag);
      renderDeals();
    }
    e.preventDefault();
  });

  // Remove filter with x button
  activeFiltersSpan.addEventListener('click', function(e){
    const tag = e.target.getAttribute('data-remove-filter');
    if(tag){
      activeFilters = activeFilters.filter(t => t !== tag);
      renderDeals();
    }
  });

  renderDeals();
})();
</script>
{% endblock %}