{% extends "layouts/base.html" %}

{% block content %}
<div class="mx-auto max-w-6xl p-6">
  <!-- Title -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold tracking-tight">Credit Card Spending</h1>
      <p class="text-sm opacity-70">Beautiful, responsive dashboard with budget awareness.</p>
    </div>
    <div class="text-right">
      <div class="text-xs uppercase opacity-60">Budget (this period)</div>
      <div class="text-2xl font-semibold">${{ 2000|default:2000 }}</div>
    </div>
  </div>

  <!-- Overview Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Total Spent</div>
      <div class="text-2xl font-semibold" id="totalSpent">$0</div>
    </div>
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Remaining</div>
      <div class="text-2xl font-semibold" id="remaining">$0</div>
    </div>
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Transactions</div>
      <div class="text-2xl font-semibold" id="txCount">0</div>
    </div>
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Avg. / Tx</div>
      <div class="text-2xl font-semibold" id="avgPerTx">$0</div>
    </div>
  </div>

  <!-- Budget Progress -->
  <div class="rounded-2xl shadow-md p-6 bg-white/70 backdrop-blur border border-slate-100 mb-8">
    <div class="flex items-end justify-between mb-3">
      <div>
        <h2 class="text-xl font-semibold">Budget Usage</h2>
        <p class="text-sm opacity-70">Tracks toward your monthly limit.</p>
      </div>
      <div id="thresholdBadge" class="text-xs px-2.5 py-1 rounded-full border hidden"></div>
    </div>

    <!-- Progress bar container -->
    <div class="relative w-full h-5 rounded-full overflow-hidden bg-slate-100 border border-slate-200" aria-label="Budget progress">
      <!-- Fill bar (force height + color visible) -->
      <div id="progressFill" 
           class="absolute left-0 top-0 h-5 z-0" 
           style="width:0%; background:#22c55e;">
      </div>
      <!-- Label (always on top) -->
      <div class="absolute inset-0 flex items-center justify-center text-xs font-medium z-10" id="progressLabel">
        0%
      </div>
    </div>    

    <div class="flex justify-between text-xs opacity-70 mt-2">
      <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
    </div>

    <div id="alerts" class="mt-4 space-y-2"></div>
  </div>

  <!-- Category Goals -->
  <div class="rounded-2xl shadow-md p-6 bg-white/70 backdrop-blur border border-slate-100 mb-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">Spending Goals</h2>
      <button id="addGoalBtn" type="button"
              class="px-3 py-2 rounded-xl border border-slate-200 shadow-md"
              style="background:#ffffff">+ Add Goal</button>
    </div>

    <form id="addGoalForm" method="post" action="{% url 'goals' %}"
      class="hidden mb-4 p-4 rounded-xl border border-slate-200" style="background:#ffffff">
      {% csrf_token %}
      <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr)); gap:.75rem; align-items:end;">
        <div>
          <label class="text-xs opacity-70">Category</label>
          <input name="category" type="text" required class="w-full p-2 rounded-lg border border-slate-200" placeholder="e.g., Food"/>
        </div>
        <div>
          <label class="text-xs opacity-70">Limit ($)</label>
          <input name="limit_amount" type="number" step="0.01" min="0" required class="w-full p-2 rounded-lg border border-slate-200" placeholder="400"/>
        </div>
        <div>
          <label class="text-xs opacity-70">Start</label>
          <input name="period_start" type="date" required class="w-full p-2 rounded-lg border border-slate-200"/>
        </div>
        <div>
          <label class="text-xs opacity-70">End</label>
          <input name="period_end" type="date" required class="w-full p-2 rounded-lg border border-slate-200"/>
        </div>
      </div>
      <div class="mt-3 flex items-center" style="gap:.5rem">
        <button type="submit" class="px-3 py-2 rounded-xl border border-slate-200 shadow-md" style="background:#22c55e; color:white">Save Goal</button>
        <button id="cancelAddGoal" type="button" class="px-3 py-2 rounded-xl border border-slate-200">Cancel</button>
      </div>
    </form>
    <ul class="space-y-3">
      {% for g in goals %}
      <li class="p-3 rounded-xl border border-slate-200 flex items-center justify-between">
        <div>
          <div class="font-medium">{{ g.category }}</div>
          <div class="text-sm opacity-70">
            ${{ g.current_spend }} / ${{ g.limit_amount }}
            <span class="opacity-60">({{ g.period_start }} → {{ g.period_end }})</span>
          </div>
        </div>
      
        <div class="flex items-center gap-2">
          <!-- Progress bar -->
          <div class="w-48">
            <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
              <div class="h-2"
              style="width: {{ g.pct }}%;
                      background-color: {{ g.color }};">
          </div>
          <div class="text-right text-xs mt-1 opacity-70">
            {{ g.pct|floatformat:0 }}%
          </div>
            </div>
            <div class="text-right text-xs mt-1 opacity-70">
              {% widthratio g.current_spend g.limit_amount 100 %}%
            </div>
          </div>
      
          <!-- Delete button -->
        <form method="post" action="" style="margin:0; display:inline;">
          {% csrf_token %}
          <input type="hidden" name="delete_goal_id" value="{{ g.id }}">
          <button type="submit"
                  class="delete-goal-btn"
                  aria-label="Delete Goal">&times;</button>
        </form>
        </div>
      </li>      
      {% empty %}
        <li class="p-3 rounded-xl border border-slate-200">No goals yet.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Recurring Transactions -->
  <div class="rounded-2xl shadow-md p-6 bg-white/70 backdrop-blur border border-slate-100 mb-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">Recurring Transactions</h2>
      <div class="text-xs opacity-70">Identified by merchant frequency</div>
    </div>
    <div class="overflow-hidden rounded-xl border border-slate-200">
      <table class="w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="text-left p-3">Merchant</th>
            <th class="text-left p-3">Category</th>
            <th class="text-center p-3">Frequency</th>
            <th class="text-right p-3">Avg. Amount</th>
          </tr>
        </thead>
        <tbody id="recurringBody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="rounded-2xl shadow-md p-6 bg-white/70 backdrop-blur border border-slate-100">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">Recent Transactions</h2>
      <div class="flex items-center" style="gap:.5rem">
        <button id="txToggleBtn" type="button"
                class="px-3 py-2 rounded-xl border border-slate-200 shadow-md"
                style="background:#ffffff">Show All</button>
        <label class="text-xs opacity-70">Sort by</label>
        <select id="sortKey" style="padding:.35rem .6rem;border:1px solid rgba(15,23,42,.12);border-radius:12px;background:#fff">
          <option value="date" selected>Date</option>
          <option value="amount">Amount</option>
          <option value="category">Type</option>
          <option value="merchant">Merchant</option>
        </select>
        <select id="sortDir" style="padding:.35rem .6rem;border:1px solid rgba(15,23,42,.12);border-radius:12px;background:#fff">
          <option value="desc" selected>Desc</option>
          <option value="asc">Asc</option>
        </select>
      </div>
    </div>
    <div class="overflow-hidden rounded-xl border border-slate-200">
      <table class="w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="text-left p-3">Merchant</th>
            <th class="text-left p-3">Category</th>
            <th class="text-left p-3">Date</th>
            <th class="text-right p-3">Amount</th>
          </tr>
        </thead>
        <tbody id="txBody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>
</div>

{% if analysis %}
<div x-data="{ open: true }" class="mt-8 max-w-3xl mx-auto">
  <!-- Toggle button -->
  <button @click="open = !open"
          class="w-full flex items-center justify-between px-5 py-3 rounded-xl border border-slate-300 shadow-sm bg-slate-50 hover:bg-slate-100 transition">
    <span class="font-semibold text-slate-800">Analysis and New Budget Report: Recent Transactions</span>
    <svg :class="{'rotate-180': open}" class="w-5 h-5 text-slate-500 transition-transform" 
         fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Collapsible content -->
  <div x-show="open" x-collapse 
     class="mt-3 rounded-xl shadow-md p-6 bg-slate-50 border border-slate-200">
  <div class="prose prose-sm max-w-none text-slate-800">
    {{ analysis|safe }}
  </div>
</div>
</div>
{% endif %}

<!-- Alpine.js -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<style>
  /* Optional: emphasize AI output better */
  .prose p { margin-bottom: 0.75rem; }
  .prose ul { list-style-type: disc; margin-left: 1.25rem; color: #334155; }
  .prose li { margin-bottom: 0.25rem; }
  .prose strong { font-weight: 600; color: #111827; }
  .hidden{display:none}
  :root{--radius:16px;--shadow:0 10px 25px -10px rgba(2,6,23,.15)}
  .rounded-2xl{border-radius:var(--radius)}.shadow-md{box-shadow:var(--shadow)}
  .bg-white\/60{background:rgba(255,255,255,.6)}.bg-white\/70{background:rgba(255,255,255,.7)}
  .border{border:1px solid rgba(15,23,42,.08)}.border-slate-100{border-color:rgba(15,23,42,.06)}.border-slate-200{border-color:rgba(15,23,42,.12)}
  .text-3xl{font-size:1.75rem}.text-2xl{font-size:1.5rem}.text-xl{font-size:1.25rem}.font-bold{font-weight:800}.font-semibold{font-weight:700}.font-medium{font-weight:600}
  .opacity-60{opacity:.6}.opacity-70{opacity:.7}.uppercase{text-transform:uppercase}
  .p-6{padding:1.5rem}.p-5{padding:1.25rem}.p-3{padding:.75rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}
  .grid{display:grid}.grid-cols-1{grid-template-columns:1fr}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.gap-4{gap:1rem}
  .mx-auto{margin-inline:auto}.max-w-6xl{max-width:72rem}.w-full{width:100%}.w-48{width:12rem}.h-5{height:1.25rem}.h-2{height:.5rem}
  .flex{display:flex}.items-center{align-items:center}.items-end{align-items:flex-end}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.text-right{text-align:right}
  .rounded-full{border-radius:9999px}.overflow-hidden{overflow:hidden}.relative{position:relative}.absolute{position:absolute}.inset-0{inset:0}
  .space-y-3>*+*{margin-top:.75rem}.space-y-2>*+*{margin-top:.5rem}
  .bg-slate-50{background:#f8fafc}.bg-slate-100{background:#f1f5f9}
  .divide-y> :not([hidden])~:not([hidden]){border-top:1px solid rgba(15,23,42,.06)}
  .delete-goal-btn {
    background: none;       /* no background */
    border: none;           /* remove border */
    padding: 0;             /* no padding */
    margin: 5;              /* no margin */
    font-size: 1.25rem;     /* similar size to before */
    font-weight: bold;
    color: #eb5e5e;         /* red-500 */
    cursor: pointer;
    line-height: 1;         /* keep it tight */
  }
  .delete-goal-btn:hover {
    color: #850f0f;         /* red-600 on hover */
}

  .tx-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }
  .tx-modal-backdrop.open { display: flex; }
  .tx-modal {
    width: min(640px, 92vw);
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 30px 80px rgba(0,0,0,.35);
    transform: scale(.96);
    opacity: 0;
    transition: transform .18s ease, opacity .18s ease;
  }
  .tx-modal-backdrop.open .tx-modal {
    transform: scale(1);
    opacity: 1;
  }
  .tx-modal-header {
    display: flex;
    align-items: start;
    justify-content: space-between;
    padding: 18px 20px 10px 20px;
    border-bottom: 1px solid rgba(15,23,42,.08);
  }
  .tx-modal-body {
    padding: 16px 20px 22px 20px;
  }
  .tx-modal-kv {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 8px 12px;
    font-size: 0.95rem;
  }
  .tx-modal-kv .label { color: rgba(15,23,42,.6); }
  .tx-row { cursor: pointer; }
  .tx-row:hover { background: rgba(15,23,42,.03); }
</style>

<script>
(function(){
  // --- Budget: sanitize to always be a number ---
  const budget = (() => {
    const raw = "{{ budget|default:1000 }}";
    const num = parseFloat(String(raw).replace(/[^0-9.-]/g, ''));
    return 2000;
  })();

  // --- Transactions: sanitize amount values ---
  const serverTx = [
    {% for t in transactions %}
      {
        tx_id: "{{ t.transaction_id|escapejs }}",
        merchant: "{{ t.merchant|escapejs }}",
        category: "{{ t.category|escapejs }}",
        date: "{{ t.date|escapejs }}",
        amount: parseFloat("{{ t.amount|default_if_none:0 }}") || 0
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const cardNames = [
    {% for c in card_names %}
      "{{ c|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // --- Goals: use as fallback for progress if tx total is 0 ---
  const serverGoals = [
    {% for g in goals %}
      {
        category: "{{ g.category|escapejs }}",
        current_spend: (function(v){
          const s = String(v).replace(/[^0-9.-]/g,'');
          const n = parseFloat(s);
          return Number.isFinite(n) ? n : 0;
        })("{{ g.current_spend|default_if_none:0 }}"),
        limit: (function(v){
          const s = String(v).replace(/[^0-9.-]/g,'');
          const n = parseFloat(s);
          return Number.isFinite(n) ? n : 0;
        })("{{ g.limit_amount|default_if_none:0 }}")
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Elements
  const tbody = document.getElementById('txBody');
  const totalSpentEl = document.getElementById('totalSpent');
  const remainingEl = document.getElementById('remaining');
  const txCountEl = document.getElementById('txCount');
  const avgPerTxEl = document.getElementById('avgPerTx');
  const fill = document.getElementById('progressFill');
  const progressLabel = document.getElementById('progressLabel');
  const badge = document.getElementById('thresholdBadge');
  const alerts = document.getElementById('alerts');
  const sortKeyEl = document.getElementById('sortKey');
  const sortDirEl = document.getElementById('sortDir');
  const txToggleBtn = document.getElementById('txToggleBtn');
  let txExpanded = false;

  // Animate progress changes
  fill.style.transition = 'width .6s ease, background-color .3s ease';

  function fmt(n){return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}

  // Compute totals with a robust fallback to goals if tx sum is 0
  function getTotals(rows){
    const totalTx = rows.reduce((s,t)=> s + (parseFloat(t.amount) || 0), 0);
    const totalGoalsSpend = serverGoals.reduce((s,g)=> s + (g.current_spend||0), 0);
    const sumGoalLimits = serverGoals.reduce((s,g)=> s + (g.limit||0), 0);

    // prefer transactions if they exist; otherwise use goals spend
    const total = totalTx > 0 ? totalTx : totalGoalsSpend;

    // prefer explicit budget; else use sum of goal limits (if any)
    const effBudget = (Number.isFinite(budget) && budget > 0)
                      ? budget
                      : (sumGoalLimits > 0 ? sumGoalLimits : 1000);

    return { total, effBudget };
  }

  function computeStats(rows){
    const { total, effBudget } = getTotals(rows);
    const remaining = Math.max(0, effBudget - total);
    const pct = Math.max(0, Math.min(100, Math.round((total / (effBudget || 1)) * 100)));

    totalSpentEl.textContent = `$${fmt(total)}`;
    remainingEl.textContent = `$${fmt(remaining)}`;
    txCountEl.textContent = rows.length;
    avgPerTxEl.textContent = `$${fmt(total/Math.max(1,rows.length))}`;

    fill.style.width = pct + '%';
    progressLabel.textContent = pct + '%';

    // Dynamic color
    const color = pct >= 75 ? '#ef4444' : (pct >= 50 ? '#f59e0b' : '#22c55e');
    fill.style.background = color;

    // Clear alerts
    alerts.innerHTML = '';
    badge.classList.add('hidden');

    function pill(text, color){
      badge.textContent = text;
      badge.classList.remove('hidden');
      badge.style.borderColor = color;
      badge.style.color = color;
      badge.style.background = color + '11';
    }
    function alert(text, color){
      const el = document.createElement('div');
      el.className = 'p-3 rounded-xl border';
      el.style.borderColor = color;
      el.style.background = color + '0F';
      el.style.color = color;
      el.textContent = text;
      alerts.appendChild(el);
    }

    if (pct >= 75) {
      pill('75%+ of budget', '#ef4444');
      alert('Warning: You\'ve used over 75% of your budget. Consider pausing discretionary spending.', '#ef4444');
    } else if (pct >= 50) {
      pill('50%+ of budget', '#f59e0b');
      alert('Heads up: You\'ve crossed 50% of your budget.', '#f59e0b');
    } else if (pct >= 25) {
      pill('25%+ of budget', '#0ea5e9');
      alert('Nice tracking! You\'re at 25% of budget. Keep an eye on upcoming bills.', '#0ea5e9');
    }

    // Debug once (safe to keep; remove if you want)
    if (!window.__budgetDebugged){
      console.log('[BudgetUsage] effBudget=', effBudget, 'total=', total, 'txCount=', rows.length, 'goals=', serverGoals);
      window.__budgetDebugged = true;
    }
  }

  function renderTable(rows){
    if (!rows.length){
      tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-center opacity-70">No transactions found</td></tr>';
      return;
    }
    const visibleRows = txExpanded ? rows : rows.slice(0, 5);
    tbody.innerHTML = visibleRows.map(t => `
      <tr class="tx-row" data-tx="1"
          data-merchant="${(t.merchant || '').replace(/"/g,'&quot;')}"
          data-category="${(t.category || '').replace(/"/g,'&quot;')}"
          data-date="${(t.date || '').replace(/"/g,'&quot;')}"
          data-amount="${t.amount}"
          data-card="${(t.card || '—').replace(/"/g,'&quot;')}">
        <td class="p-3 font-medium">${t.merchant}</td>
        <td class="p-3 opacity-80">${t.category || ''}</td>
        <td class="p-3 opacity-70">${t.date}</td>
        <td class="p-3 text-right font-semibold">$${fmt(t.amount)}</td>
      </tr>
    `).join('');

    if (txToggleBtn) {
      const hasMore = rows.length > 5;
      txToggleBtn.style.display = hasMore ? 'inline-flex' : 'none';
      txToggleBtn.textContent = txExpanded ? 'Show Less' : 'Show All';
    }
  }

  // Identify and render recurring transactions
  function renderRecurringTransactions(rows){
    const recurringBody = document.getElementById('recurringBody');
    if (!recurringBody) return;

    // Group transactions by merchant
    const merchantGroups = {};
    rows.forEach(t => {
      const merchant = t.merchant || 'Unknown';
      if (!merchantGroups[merchant]) {
        merchantGroups[merchant] = {
          merchant: merchant,
          category: t.category,
          transactions: [],
          totalAmount: 0
        };
      }
      merchantGroups[merchant].transactions.push(t);
      merchantGroups[merchant].totalAmount += parseFloat(t.amount) || 0;
    });

    // Filter for recurring (appearing 2+ times)
    const recurring = Object.values(merchantGroups)
      .filter(g => g.transactions.length >= 2)
      .sort((a, b) => b.transactions.length - a.transactions.length);

    if (!recurring.length) {
      recurringBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center opacity-70">No recurring transactions detected</td></tr>';
      return;
    }

    recurringBody.innerHTML = recurring.map(r => {
      const avgAmount = r.totalAmount / r.transactions.length;
      return `
        <tr>
          <td class="p-3 font-medium">${r.merchant}</td>
          <td class="p-3 opacity-80">${r.category || ''}</td>
          <td class="p-3 text-center">
            <span class="px-2 py-1 rounded-full text-xs font-semibold" style="background:#e0e7ff;color:#4f46e5">
              ${r.transactions.length}x
            </span>
          </td>
          <td class="p-3 text-right font-semibold">$${fmt(avgAmount)}</td>
        </tr>
      `;
    }).join('');
  }

  function sortRows(rows, key, dir){
    const m = dir === 'asc' ? 1 : -1;
    const arr = rows.slice();
    arr.sort((a,b)=>{
      let A,B;
      if (key === 'date') { A = new Date(a.date); B = new Date(b.date); }
      else if (key === 'amount') { A = Number(a.amount)||0; B = Number(b.amount)||0; }
      else if (key === 'category') { A = (a.category||'').toLowerCase(); B = (b.category||'').toLowerCase(); }
      else if (key === 'merchant') { A = (a.merchant||'').toLowerCase(); B = (b.merchant||'').toLowerCase(); }
      else { A = 0; B = 0; }
      if (A < B) return -1*m;
      if (A > B) return 1*m;
      return 0;
    });
    return arr;
  }

  function hashString(s){
    let h = 0;
    for (let i = 0; i < s.length; i++) {
      h = ((h << 5) - h) + s.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }

  function pickCardForTx(t){
    if (!cardNames.length) return '—';
    const key = t.tx_id || `${t.merchant}|${t.date}|${t.amount}`;
    const idx = hashString(String(key)) % cardNames.length;
    return cardNames[idx] || '—';
  }

  function apply(){
    const key = sortKeyEl.value || 'date';
    const dir = sortDirEl.value || 'desc';
    const withCards = serverTx.map(t => ({ ...t, card: pickCardForTx(t) }));
    const sorted = sortRows(withCards, key, dir);
    renderTable(sorted);
    computeStats(sorted);
    renderRecurringTransactions(withCards); // Use mapped data for recurring analysis
  }

  // Toggle Add Goal form
  const addBtn = document.getElementById('addGoalBtn');
  const addForm = document.getElementById('addGoalForm');
  const cancelBtn = document.getElementById('cancelAddGoal');
  if (addBtn && addForm){ addBtn.addEventListener('click', ()=> addForm.classList.toggle('hidden')); }
  if (cancelBtn && addForm){ cancelBtn.addEventListener('click', ()=> addForm.classList.add('hidden')); }

  sortKeyEl.addEventListener('change', apply);
  sortDirEl.addEventListener('change', apply);
  if (txToggleBtn) {
    txToggleBtn.addEventListener('click', () => {
      txExpanded = !txExpanded;
      apply();
    });
  }

  // Initial render
  apply();

  // Transaction detail modal (lazy lookup so it works even if markup appears after script)
  let txBackdrop = null;
  let txMerchant = null;
  let txAmount = null;
  let txCategory = null;
  let txDate = null;
  let txCard = null;

  function ensureTxModalEls() {
    if (txBackdrop) return true;
    txBackdrop = document.getElementById('txModalBackdrop');
    txMerchant = document.getElementById('txMerchant');
    txAmount = document.getElementById('txAmount');
    txCategory = document.getElementById('txCategory');
    txDate = document.getElementById('txDate');
    txCard = document.getElementById('txCard');
    return !!txBackdrop;
  }

  function openTxModal(data) {
    if (!ensureTxModalEls()) return;
    txMerchant.textContent = data.merchant || 'Unknown';
    txAmount.textContent = `$${fmt(data.amount || 0)}`;
    txCategory.textContent = data.category || '—';
    txDate.textContent = data.date || '—';
    txCard.textContent = data.card || '—';
    txBackdrop.classList.add('open');
  }
  function closeTxModal() {
    if (!ensureTxModalEls()) return;
    txBackdrop.classList.remove('open');
  }

  if (tbody) {
    tbody.addEventListener('click', (e) => {
      const row = e.target.closest('tr[data-tx]');
      if (!row) return;
      openTxModal({
        merchant: row.getAttribute('data-merchant'),
        category: row.getAttribute('data-category'),
        date: row.getAttribute('data-date'),
        amount: parseFloat(row.getAttribute('data-amount') || '0'),
        card: row.getAttribute('data-card'),
      });
    });
  }

  document.addEventListener('click', (e) => {
    if (!ensureTxModalEls()) return;
    if (e.target === txBackdrop) closeTxModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeTxModal();
  });
})();
</script>

<div id="txModalBackdrop" class="tx-modal-backdrop" role="dialog" aria-modal="true" aria-label="Transaction details">
  <div class="tx-modal">
    <div class="tx-modal-header">
      <div>
        <div class="text-xs uppercase opacity-60">Transaction</div>
        <div id="txMerchant" class="text-xl font-semibold">—</div>
      </div>
      <button class="px-3 py-2 rounded-xl border border-slate-200" onclick="document.getElementById('txModalBackdrop').classList.remove('open')">
        Close
      </button>
    </div>
    <div class="tx-modal-body">
      <div class="tx-modal-kv">
        <div class="label">Amount</div><div id="txAmount">—</div>
        <div class="label">Category</div><div id="txCategory">—</div>
        <div class="label">Date</div><div id="txDate">—</div>
        <div class="label">Card</div><div id="txCard">—</div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
